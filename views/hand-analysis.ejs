<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport"
        content="width=device-width, initial-scale=1">
  <title>Mahjong Tool Box</title>

  <!-- Set render engine for 360 browser -->
  <meta name="renderer" content="webkit">

  <!-- No Baidu Siteapp-->
  <meta http-equiv="Cache-Control" content="no-siteapp"/>

  <link rel="icon" type="image/png" href="AmazeUI/assets/i/favicon.png">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" href="AmazeUI/assets/i/app-icon72x72@2x.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Amaze UI"/>
  <link rel="apple-touch-icon-precomposed" href="AmazeUI/assets/i/app-icon72x72@2x.png">

  <!-- Tile icon for Win8 (144x144 + tile color) -->
  <meta name="msapplication-TileImage" content="AmazeUI/assets/i/app-icon72x72@2x.png">
  <meta name="msapplication-TileColor" content="#0e90d2">

  <link rel="stylesheet" href="AmazeUI/assets/css/amazeui.min.css">
  <link rel="stylesheet" href="AmazeUI/assets/css/app.css">
  <style>
    .centeralign {
      text-align: center;
    }
  </style>
</head>
<body>

<%- include navbar.ejs %>

<div class="centeralign">
  <table id="tiles" class="am-table am-table-bordered am-table-radius am-table-striped">
    <thead>
      <tr>
        <th>手牌</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><div name="display-0" style="min-height:59px"></div></td>
      </tr>
    </tbody>
    <thead name="display-hide">
      <tr>
        <th>副露</th>
      </tr>
    </thead>
    <tbody name="display-hide">
      <tr>
        <td><div name="display-1" style="min-height:59px"></div></td>
      </tr>
    </tbody>
    <thead name="display-hide">
      <tr>
        <th>暗槓</th>
      </tr>
    </thead>
    <tbody name="display-hide">
      <tr>
        <td><div name="display-2" style="min-height:59px"></div></td>
      </tr>
    </tbody>
  </table>
  <div id="result" class="am-g">
    <div class="am-u-sm-11 am-u-sm-centered">
      <table class="am-table am-table-bordered am-table-radius am-table-striped">
        <thead>
          <tr><th>計算結果</th></tr>
        </thead>
        <tbody>
          <tr><td>
            <div name="display-yaku"></div>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div>
    <div class="am-btn-group am-btn-group-justify doc-js-btn-1" data-am-button>
      <label class="am-btn am-btn-primary am-btn-xl">
        <input type="radio" name="tile-kind" value="30" id="option1" class="needsclick">字
      </label>
      <label class="am-btn am-btn-primary am-btn-xl">
        <input type="radio" name="tile-kind" value="0" id="option2" class="needsclick" checked>萬
      </label>
      <label class="am-btn am-btn-primary am-btn-xl">
        <input type="radio" name="tile-kind" value="10" id="option4" class="needsclick">筒
      </label>
      <label class="am-btn am-btn-primary am-btn-xl">
        <input type="radio" name="tile-kind" value="20" id="option3" class="needsclick">索
      </label>
    </div>
    <div class="am-btn-group am-btn-group-justify doc-js-btn-1" name="tile-kinds" data-am-button>
      <label class="am-btn am-btn-secondary am-btn-xl">
        <input type="radio" name="tile-target" value="0" id="option2" class="needsclick" checked>手牌
      </label>
      <label class="am-btn am-btn-secondary am-btn-xl">
        <input type="radio" name="tile-target" value="1" id="option3" class="needsclick">副露
      </label>
      <label class="am-btn am-btn-secondary am-btn-xl">
        <input type="radio" name="tile-target" value="2" id="option4" class="needsclick">暗槓
      </label>
    </div>
  </div>
  <div id="normal-keyboard">
    <div class="am-btn-group am-btn-group-justify">
      <a class="am-btn am-btn-default am-btn-xl tile-1" role="button">1</a>
      <a class="am-btn am-btn-default am-btn-xl tile-2" role="button">2</a>
      <a class="am-btn am-btn-default am-btn-xl tile-3" role="button">3</a>
    </div>
    <div class="am-btn-group am-btn-group-justify">
      <a class="am-btn am-btn-default am-btn-xl tile-4" role="button">4</a>
      <a class="am-btn am-btn-default am-btn-xl tile-5" role="button">5</a>
      <a class="am-btn am-btn-default am-btn-xl tile-6" role="button">6</a>
    </div>
    <div class="am-btn-group am-btn-group-justify">
      <a class="am-btn am-btn-default am-btn-xl tile-7" role="button">7</a>
      <a class="am-btn am-btn-default am-btn-xl tile-8" role="button">8</a>
      <a class="am-btn am-btn-default am-btn-xl tile-9" role="button">9</a>
    </div>
  </div>
  <div id="special-keyboard">
    <div class="am-btn-group am-btn-group-justify">
      <a class="am-btn am-btn-default am-btn-xl tile-5" role="button">白</a>
      <a class="am-btn am-btn-default am-btn-xl tile-6" role="button">發</a>
      <a class="am-btn am-btn-default am-btn-xl tile-7" role="button">中</a>
    </div>
    <div class="am-btn-group am-btn-group-justify">
      <a class="am-btn am-btn-default am-btn-xl tile-1" role="button">東</a>
      <a class="am-btn am-btn-default am-btn-xl tile-2" role="button">南</a>
      <a class="am-btn am-btn-default am-btn-xl tile-3" role="button">西</a>
    </div>
    <div class="am-btn-group am-btn-group-justify">
      <a class="am-btn am-btn-primary am-btn-xl tile-8 am-disabled" role="button"> </a>
      <a class="am-btn am-btn-default am-btn-xl tile-4" role="button">北</a>
      <a class="am-btn am-btn-primary am-btn-xl tile-9 am-disabled" role="button"> </a>
    </div>
  </div>
  <div class="am-btn-group am-btn-group-justify">
    <a class="am-btn am-btn-success am-btn-xl fuuro-submit" role="button">副露提出</a>
    <a class="am-btn am-btn-danger am-btn-xl tile-submit" role="button">提出</a>
    <a class="am-btn am-btn-warning am-btn-xl tile-reset" role="button">RESET</a>
  </div>
</div>

<!--[if (gte IE 9)|!(IE)]><!-->
<script src="AmazeUI/assets/js/jquery.min.js"></script>
<!--<![endif]-->
<!--[if lte IE 8 ]>
<script src="http://libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="AmazeUI/assets/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->
<script src="AmazeUI/assets/js/amazeui.min.js"></script>
<script src="javascripts/mahjong-keyboard-control.js"></script>
<script src="javascripts/shanten-calculate.js"></script>
<script>
  function convert(hand){
    result = [];
    for(var i = 0; i < hand.length; i++){
      result.push(hand[i] - (1 + Math.floor(hand[i]/10)));
    }
    return result;
  }

  function getValidDraw(hand, currentShantensu){
    console.log(hand);
    console.log(currentShantensu);
    if(hand.length != 13 || currentShantensu == -1){
      return [];
    }
    var result = [];
    for(var i = 0; i < 34; i++){
      var temp_hand = hand.slice();
      temp_hand.push(i);
      temp_hand.sort(sortNumber);
      if(calculateShantensu(temp_hand) < currentShantensu){
        result.push(i);
      }
    }
    return result;
  }

  function getDiscardCandidate(hand, currentShantensu){
    // No what-to-discard problem if there is only 13 tiles
    if(hand.length == 13){
      return [];
    }
    // Delete repeated items and save as candidates
    var candidates = [];
    for(var i = 0; i < hand.length; i++){
      if(candidates.indexOf(hand[i]) == -1){
        candidates.push(hand[i]);
      }
    }

    var finalCandidates =[];
    for(var i = 0; i < candidates.length; i++){
      var temp = hand.slice();
      temp.splice(temp.indexOf(candidates[i]), 1);
      if(calculateShantensu(temp) == currentShantensu){
        finalCandidates.push(candidates[i]);
      }
    }
    return finalCandidates;
  }

  function calculate(){
    var handTemp = hand.slice();
    if(agari != -1){
      handTemp.push(agari);
    }
    handTemp = convert(handTemp);
    var currentShantensu = calculateShantensu(handTemp);
    var discardCandidates = getDiscardCandidate(handTemp, currentShantensu);
    var validDrawList = [];
    for(var i = 0; i < discardCandidates.length; i++){
      var temp = handTemp.slice();
      temp.splice(temp.indexOf(discardCandidates[i]), 1);
      var validList = getValidDraw(temp, currentShantensu);
      validDrawList.push(validList);
    }

    $('[name="display-yaku"]').empty();
    var htmlContent = '';
    for(var i = 0; i < handTemp.length; i++){
      htmlContent = htmlContent + '<img src="images/mahjong-simple/tile (' + (handTemp[i] + 1) + ').png">';
    }
    // 14 tiles' case
    if(currentShantensu != -1){
      if (currentShantensu > 0){
        htmlContent = htmlContent + "<br>" + currentShantensu + "向聴<br>";
        for(var i = 0; i < discardCandidates.length; i++){
          htmlContent = htmlContent + "<p>打 " + '<img src="images/mahjong-simple/tile (' + (discardCandidates[i] + 1) + ').png">' + " ツモ ";
          for(var j = 0; j < validDrawList[i].length; j++){
            htmlContent = htmlContent + '<img src="images/mahjong-simple/tile (' + (validDrawList[i][j] + 1) + ').png">';
          }
          htmlContent = htmlContent + "<br>";
        }
      }
      else if (currentShantensu == 0){
        htmlContent = htmlContent + "<br>聴牌<br>";
        for(var i = 0; i < discardCandidates.length; i++){
          htmlContent = htmlContent + "<p>打 " + '<img src="images/mahjong-simple/tile (' + (discardCandidates[i] + 1) + ').png">' + " 待ち ";
          for(var j = 0; j < validDrawList[i].length; j++){
            htmlContent = htmlContent + '<img src="images/mahjong-simple/tile (' + (validDrawList[i][j] + 1) + ').png">';
          }
          htmlContent = htmlContent + "<br>";
        }
      }
    }
    else{
      htmlContent = htmlContent + "<br>和了<br>";
    }

    $('[name="display-yaku"]').append(htmlContent);
  }
  $('.tile-submit').click(function () {
    calculate();
    $('#tiles').hide();
    $('#result').show();
  });
</script>
<script>
  $(document).ready(function(){
    $("ul li:eq(0)").addClass('am-active');
    $('[name="display-hide"]').hide();
    $('[name="tile-kinds"]').hide();
    $('.fuuro-submit').addClass('am-disabled ');
  });
</script>
</body>
</html>